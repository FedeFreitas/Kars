services:
  db:
    image: postgres:16
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: appdb
    ports: ["5432:5432"]
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./docker/db/init.sql:/docker-entrypoint-initdb.d/01_init.sql:ro

  api:
    build: ./apps/api
    environment:
      NODE_ENV: development
      API_PORT: 4000
      CORS_ORIGIN: http://localhost:3000
      DATABASE_URL: postgres://postgres:postgres@db:5432/appdb
      JWT_ACCESS_SECRET: changeme_access
      JWT_REFRESH_SECRET: changeme_refresh
      ACCESS_TOKEN_TTL: 15m
      REFRESH_TOKEN_TTL_DAYS: 7
      SECURE_COOKIES: "false"
      CHOKIDAR_USEPOLLING: "true"
      SMTP_HOST: mailcatcher
      SMTP_PORT: 1025
      MAIL_FROM: "no-reply@kars.local"
    ports: ["4000:4000"]
    depends_on: [db]
    volumes:
      - ./apps/api:/app
      - /app/node_modules
    command: sh -c "npm i && npx nodemon -L"

  web:
    build: ./apps/web
    environment:
      NODE_ENV: development
      API_URL: http://api:4000
      # importante p/ Windows/WSL:
      CHOKIDAR_USEPOLLING: "true"
      WATCHPACK_POLLING: "true"
    ports: ["3000:3000"]
    depends_on: [api]
    volumes:
      - ./apps/web:/app # monta o c√≥digo fonte
      - /app/node_modules
    command: sh -c "npm i && npx next dev -H 0.0.0.0 -p 3000"

  mailcatcher:
    image: sj26/mailcatcher:latest
    restart: always
    ports:
      - "1080:1080" # UI
      - "1025:1025" # SMTP

volumes:
  pgdata:
